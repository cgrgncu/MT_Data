# 時間序列資料格式研究

### 時間序列檔案格式規格書
+ DAA09 - DataFormat 3rd Party v2.0 - 210915.pdf

### 相容硬體型號  
+ MTU-8A 
+ RXU-8A
+ MTU-5C
+ MTU-2C
+ MTU-5D
+ 其他延伸產品
  
### 相容軟體/韌體版本
+ v2.0以上版本

### 原生取樣率  
+ MTU-8A : 24K[SPS]
+ RXU-8A : 24K[SPS]
+ MTU-5C : 24K[SPS]
+ MTU-2C : 24K[SPS]
+ MTU-5D : 96K[SPS]

### SD卡中的存放位置
+ 「recdata」資料夾中
+ 「recdata」資料夾中每次連續紀錄會建立一個獨一無二的資料夾，命名方式如下:
  + XXXXX_YYYY-MM-DD-HHNNSS，例如: 12345_2016-04-29-202957 。
  + XXXXX為五個數字，代表儀器序號，例如: 12345 。
  + YYYY-MM-DD為記錄起始時間年月日，來自GPS時間(UTC+潤秒)。其中YYYY為西元年(四碼)，MM為月(兩碼)，DD為日(兩碼)。
  + HHNNSS為記錄起始時間時分秒，來自GPS時間(UTC+潤秒)。其中HH為24制小時(兩碼)，NN為分(兩碼)，SS為秒(兩碼)。  
+ 該紀錄資料夾(例如「12345_2016-04-29-202957」資料夾)中會存在以下資料夾及檔案:
  + 由單純數字遞增的紀錄資料夾們，例如:「0」、「1」、「2」、「3」、「4」。通常是指:「H2(Hy)」、「E1(Ex)」、「H1(Hx)」、「H3(Hz)」、「E2(Ey)」。
  + 「backend.log」檔案: MTU主機開機後的主要運行工作紀錄檔案。
  + 「config.json」檔案: MTU主機開機後依照此設定檔案進行紀錄工作。檔案內容與野外操作前編輯好放入SD卡的檔案一致。
  + 「recmeta.json」檔案: 描述與記錄檔案有關的參數。由MTU主機運作時產出的檔案，內容若有變化可能與韌體版本有關。
  + 「recmeta.json.bak」檔案: 「recmeta.json」檔案的備份。可能EMpower會用到。
  + 「empower_recmeta.json」檔案: 這個檔案並不是必須存在，若存在表示給EMpower軟體使用。可能EMpower會將使用者參數的編輯與修正儲存在此檔案中而不會損毀原始的參數檔案，細節待確認。
  + 「stats」檔案: 儲存記錄檔案的統計資訊。目前是屬於實驗性的功能??
  + 「executor.log」檔案: 儲存運行中的特殊事件紀錄。

### 連續型時間序列資料格式(format of continuous time series)
+ 命名方式: AAAAA_BBBBBBBB_C_DDDDDDDD.bin
  + XXXXX為5個數字，代表儀器序號，例如: 12345 。
  + BBBBBBBB為8個英數字，為32位元無號數十六進制標籤，表示記錄開始時間的時間戳，與序列號一起構成記錄的唯一ID。
    + 這個時間戳是原廠自訂的格式，使用「UNIX時間(Unix-epoch)」的時間起點(UTC1970年1月1日0時0分0秒起)。
    + 時間戳為經過的秒數，標註為32位元無號數十六進制標籤。
    + 使用GPS時間標準而非UTC時間。這表示會與一般認知的UTC時間差距整數倍秒，可以理解這是因為儀器採用GPS時鐘而選擇的高效率儲存方案。 
    + 這個時間序列定義在舊版本(Time Series v4之前，對應儀器韌體版本v2.0之前)存在錯誤，其錯誤原因與GPS晶片硬體及驅動有關，紀錄時間將落後GPS時間1秒。在後續的版本已經修正此問題。因為此文件也是針對韌體版本v2.0以後版本描述，所以我只針對後續版本測試。
      ```
      + 協調世界時間，UTC（Coordinated Universal Time）：
        + 它是最主要的世界時間標準，基於國際原子時鐘，並通過不規則的加入閏秒來抵消地球自轉變慢的影響。
        + 它又稱為世界統一時間、世界標準時間、國際協調時間。由於英文（CUT）和法文（TUC）的縮寫不同，作為妥協，簡稱UTC。
        + 協調世界時間（UTC）是世界上調節時鐘和時間的主要時間標準，是最接近格林威治標準時間（GMT）的幾個替代時間系統之一。
        + 對於大多數用途來說，UTC時間被認為能與GMT時間互換。
        + 人們對該時間系統進行過數次調整，直到1972年引入了閏秒機制，調整工作得以簡化。
      + Unix或POSIX時間戳：
        + 它是UNIX或類UNIX系統使用的時間表示方式。
        + 一般定義為從協調世界時(UTC時間)1970年1月1日0時0分0秒起至現在的總秒數（10位是精確到秒，13位是精確到毫秒）。
        + 考慮到閏秒的話，更精確的定義為從協調世界時(UTC時間)1970年1月1日0時0分0秒起至現在經過閏秒調整之後的總秒數
      + GPS時間：
        + 它是GPS原子時鐘，它的時間基準是1980年1月6日0時0分0秒與世界協調時刻UTC相一致，以後按原子時鐘秒長累積計時。
        + GPS時間不做潤秒調整。GPS時間跟UTC時間之差為秒的整倍數。例如：1989年為5秒，1996年為11秒，2002年為13秒，到現在2020年08月為止為18秒。
      ```
      ```matlab
      %**************************************************************************
      %   Name: yeh_PHOENIX_GPS_timestamp_to_datestr_example_v20221226a.m 
      %   Copyright:  
      %   Author: HsiupoYeh 
      %   Version: v20221226a
      %   Description: 將MTU-5C的GPS時間戳轉為時間文字的範例。
      %                經過測試可用於MATLAB R2009a版本。
      %**************************************************************************
      clear;clc;close all
      %==========================================================================
          %----------------------------------------------------------------------
      Input_AAAAA_BBBBBBBB_C_DDDDDDDD_bin_str='10421_63366CDB_0_0000000A.bin';
          disp(['紀錄檔案名稱: ',Input_AAAAA_BBBBBBBB_C_DDDDDDDD_bin_str])
          % 紀錄檔案名稱: 10421_63366CDB_0_0000000A.bin
          %--
          Input_AAAAA_part_str=Input_AAAAA_BBBBBBBB_C_DDDDDDDD_bin_str(1:5);
          disp(['「AAAAA」部分: ',Input_AAAAA_part_str])
          % 「AAAAA」部分: 10421
          %--
          Input_BBBBBBBB_part_str=Input_AAAAA_BBBBBBBB_C_DDDDDDDD_bin_str(7:14);
          disp(['「BBBBBBBB」部分: ',Input_BBBBBBBB_part_str])
          % 「BBBBBBBB」部分: 63366CDB
          %--
          Input_C_part_str=Input_AAAAA_BBBBBBBB_C_DDDDDDDD_bin_str(16:16);
          disp(['「C」部分: ',Input_C_part_str])
          % 「C」部分: 0
          %--
          Input_DDDDDDDD_part_str=Input_AAAAA_BBBBBBBB_C_DDDDDDDD_bin_str(18:25);
          disp(['「DDDDDDDD」部分: ',Input_DDDDDDDD_part_str])
          % 「DDDDDDDD」部分: 0000000A
          %----------------------------------------------------------------------
          % 計算日期
          %--
          % UNIX時間起點
          JulianDate_datetime=datenum(1970,1,1,0,0,0);
          %--
          % 經過時間秒數
          elapsed_time_in_seconds=hex2dec(Input_BBBBBBBB_part_str);
          %--
          % 計算GPS +00:00時間
          GPS_date_str=datestr(JulianDate_datetime+elapsed_time_in_seconds/86400,'yyyy-mm-dd HH:MM:SS');
          disp([GPS_date_str,' (GPS +00:00)'])
          % 2022-09-30 04:13:15 (GPS +00:00)
          %--
          % 計算GPS +08:00時間
          GPS_date_plus8_str=datestr(JulianDate_datetime+elapsed_time_in_seconds/86400+3600*8/86400,'yyyy-mm-dd HH:MM:SS');
          disp([GPS_date_plus8_str,' (GPS +08:00)'])
          % 2022-09-30 12:13:15 (GPS +08:00)
          %----------------------------------------------------------------------
      ```
  + C為1個數字，做為頻道代號ID，從0開始。與所在紀錄資料夾相同數字，例如:「0」、「1」、「2」、「3」、「4」。通常是指:「H2(Hy)」、「E1(Ex)」、「H1(Hx)」、「H3(Hz)」、「E2(Ey)」。
  + DDDDDDDD為8個英數字，為32位元無號數十六進制標籤，紀錄器每一段時間將資料儲存為一個檔案，此標籤為該檔案的索引。每個檔案每分鐘都在儲存一次，此索引值的極限設計為可以儲存8100年的連續數據。目前儲存每分鐘一次這個週期是固定的，未來可能改動為可以規劃設定的。索引從「00000001」開始，依序「00000002」、「00000003」、「00000004」、「00000005」、「00000006」、「00000007」、「0000000A」...，若照Windows檔案名稱排序可能部分資料會排到後面去。
  
+ 檔頭內容: 
  + 紀錄檔案是順序性的儲存。
  + 每一個檔案都包含檔頭，有用的資料儲存在檔頭之後。這樣的設計可以在其他檔案不存在的時候查看內部有用資料。
  + 檔頭格式如表格。
  + 除非在檔頭內指定欄位有設定，否則預設是使用「Little-Endian」位元順序。

+ 資料部分內容規範:
  + 資料由許多個64[Bytes]的區塊所組成，這些區塊被稱為「幀(frames)」。註:在計算機通訊領域，「幀(frames)」通常是指數位資料傳輸單元或數位封包。  
  + 每個「幀(frames)」的內容如下:
    + frames(64[Bytes])=Data(60[Bytes])+Footer(4[Bytes])。 
      + Data(60[Bytes])為20個連續的取樣點。各取樣點為3[Bytes]，為24位元有號整數，「Big-Endian」位元順序。
      + Footer(4[Bytes])為32位元無號整數，使用「Little-Endian」位元順序。但這個無號整數部分位元有特殊用法，細節以後再看...

### 降取樣型時間序列資料格式(format of decimated time series)
+ 目的: 從原始A/D取樣率的資料中抽取出降取樣型時間序列的主要目的是減少需要儲存的數據量，使用戶能夠在更短的時間內傳輸資料，使用更少的儲存空間將資料歸檔。
+ 命名方式: AAAAA_BBBBBBBB_C_DDDDDDDD.tdE
  + XXXXX為5個數字，代表儀器序號，例如: 12345 。
  + BBBBBBBB為8個英數字，為32位元無號數十六進制標籤，表示記錄開始時間的時間戳，與序列號一起構成記錄的唯一ID。
  + C為1個數字，做為頻道代號ID，從0開始。與所在紀錄資料夾相同數字，例如:「0」、「1」、「2」、「3」、「4」。通常是指:「H2(Hy)」、「E1(Ex)」、「H1(Hx)」、「H3(Hz)」、「E2(Ey)」。
  + DDDDDDDD為8個英數字，為32位元無號數十六進制標籤，紀錄器每一段時間將資料儲存為一個檔案，此標籤為該檔案的索引。每個檔案6分鐘或10分鐘儲存一次，此索引值的極限設計為可以儲存超過10000年的連續數據。索引從「00000001」開始，依序「00000002」、「00000003」、「00000004」、「00000005」、「00000006」、「00000007」、「0000000A」...，若照Windows檔案名稱排序可能部分資料會排到後面去。
  + E為不定數量的多個英數字，代表降取樣後的取樣率。例如:「td_24K」表示取樣率為24000[SPS]，「td_150」表示取樣率為150[SPS]。
